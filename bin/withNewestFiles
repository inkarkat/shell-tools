#!/bin/bash
shopt -qs extglob

: ${WITHNEWESTFILES_COMMAND_JOINER=;}
: ${WITHNEWESTFILES_EXEC_END=;}
: ${WITHNEWESTFILES_FILES_END=;}
: ${WITHNEWESTFILES_FILE_MARKER='{}'}
fileMarker="$WITHNEWESTFILES_FILE_MARKER"; unset WITHNEWESTFILES_FILE_MARKER

printUsage()
{
    cat <<HELPTEXT
Execute COMMAND on the last modified file(s) (which ${fileMarker:+either }is appended${fileMarker:+ or
replaces any $fileMarker marker} inside COMMANDLINE) in ${dirspecs:-DIR}.
HELPTEXT
    echo
    local commonArgs="[-t|--newer-than EPOCH|-N|--newer FILE|'FILE-GLOB' [...]|-n|--count N] -c|--command \"COMMANDLINE\" [-c ...] | --exec SIMPLECOMMAND [...] ${WITHNEWESTFILES_EXEC_END} [--exec ...] | SIMPLECOMMAND [...]"
    if [ -n "$dirspecs" ]; then
	printf 'Usage: %q %s\n' "${WITHNEWESTFILES_WRAPPER:-$(basename "$1")}" "${commonArgs} [-?|-h|--help]"
    else
	printf 'Usage: %q %s\n' "$(basename "$1")" "${commonArgs} [--] DIR [...] [-?|-h|--help]"
	echo
	printf 'Usage: %q %s\n' "$(basename "$1")" "-f|--files DIR [...] ${WITHNEWESTFILES_FILES_END} [-f ...] ${commonArgs} [-?|-h|--help]"
    fi
}

dirspecs=
typeset -a allargs=()
typeset -a newestFilesArgs=()
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printUsage "$0"; exit 0;;

	-[tN])		newestFilesArgs+=("$1" "${2?}"); shift; shift;;
	-n)		newestFilesArgs+=(--count "${2?}"); shift; shift;;  # -c N clashes with -c COMMANDLINE; rename to -n
	--@(newer-than|newer|count))
			newestFilesArgs+=("$1" "${2?}"); shift; shift;;

	--files|-f)	allargs+=("$1"); shift
			while [ $# -gt 0 -a "$1" != "$WITHNEWESTFILES_FILES_END" ]
			do
			    dirspecs+="${dirspecs:+, }$1"
			    allargs+=("$1"); shift
			done
			allargs+=("$1"); shift
			;;
	--)		allargs+=("$1"); shift; break;;
	*)		allargs+=("$1"); shift;;
    esac
done
set -- "${allargs[@]}" "$@"


WITHSELECTEDFILES_COMMAND_JOINER="$WITHNEWESTFILES_COMMAND_JOINER" \
WITHSELECTEDFILES_EXEC_END="$WITHNEWESTFILES_EXEC_END" \
WITHSELECTEDFILES_FILES_END="$WITHNEWESTFILES_FILES_END" \
WITHSELECTEDFILES_FILE_MARKER="$fileMarker" \
    exec withSelectedFiles --select-exec newestFiles "${newestFilesArgs[@]}" -- {} \; "$@"
