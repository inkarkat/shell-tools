#!/bin/bash

printUsage()
{
    eachSplit --help 2>&1 | sed \
	-e '1s#^.*$#Split standard input into sections separated by PATTERN (two or three dashes by\ndefault) and execute COMMAND with each section file (which either is appended or\nreplaces any {} marker inside COMMANDLINE).#' \
	-e '2b removeFirstParagraphLoop' \
	-e 's/SPLIT-OPTIONS \.\.\./-S|--section-separator PATTERN/g' \
	-e '/^SEE ALSO:/a\
- dishOutSections dynamically prints individual sections on each invocation.\
- eachCsplit is a generalization that allows the use of different separators and\
  fine-grained control of offsets and repetitions.' \
	-e '/^ *--splitter/i\
    --section-separator|-S PATTERN\
			Lines matching PATTERN separate the individual sections\
			within the FILE. These lines are not part of the output.\
			PATTERN is a POSIX-style unanchored basic regular\
			expression. The default separator is two or three\
			dashes.' \
	-e '/^ *--splitter/b removeOptionLoop' \
	-e '/^Usage:$/N' -e '/\(^\|\n\)Usage: */{ s/\(^\|\n\)\(Usage: *\)\?\([^ |]\+ \)*eachSplit /\1\2'"$(basename "$1")"' /; s/\[--splitter SPLIT-COMMAND OPTIONS FILE PREFIX ARGS ;\] //; }' \
	-e '/^Example:$/N' -e '/\(^\|\n\)Example: */{ s/\(^\|\n\)\(Example: *\)\?eachSplit /\1\2'"$(basename "$1") /; }" \
	-e b -e :removeFirstParagraphLoop -e '{ /\(^\|\n\)$/{ s/^\(.*\n\)\?//; b; }; N; b removeFirstParagraphLoop; }' \
	-e b -e :removeOptionLoop -e '{ /\n *--splitter[^\n]*$/{ N; b removeOptionLoop; }; /\n *--[^\n]*$\|\n[^	 ]\|\n$/{ s/^\(.*\n\)\?//; b; }; N; b removeOptionLoop; }'
}

separatorPattern='^-\{2,3\}$'
typeset -a args=()
while [ $# -ne 0 ]
do
    case "$1" in
	--help|-h|-\?)	shift; printUsage "$0"; exit 0;;
	--section-separator|-S)
			shift; separatorPattern="${1:?}"; shift;;
	--)		args+=("$1"); shift; break;;
	*)		args+=("$1"); shift;;
    esac
done

exec eachSplit --splitter csplit --suppress-matched --prefix=PREFIX OPTIONS FILE ARGS \; "/${separatorPattern}/" '{*}' "${args[@]}" "$@"
